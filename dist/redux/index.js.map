{"version":3,"sources":["../../src/redux/index.js"],"names":["Redux","require","Promise","_","composeWithDevTools","fs","mitt","stringify","emitter","reducers","initialState","rootNodeMap","WeakMap","JSON","parse","readFileSync","process","cwd","each","nodes","id","node","trackSubObjectsToRootNodeId","e","store","env","REDUX_DEVTOOLS","sitePackageJSON","composeEnhancers","realtime","port","name","createStore","combineReducers","applyMiddleware","saveState","debounce","state","pickedState","pick","writeFile","subscribe","lastAction","getState","emit","type","on","exports","getNodes","values","getNode","hasNodeChanged","digest","internal","contentDigest","loadNodeContent","content","resolve","plugin","flattenedPlugins","find","plug","owner","Error","then","getNodeAndSavePathDependency","path","createPageDependency","nodeId","getRootNodeId","get","addParentToSubObjects","data","parentId","isPlainObject","isArray","o","set","v","k","parent"],"mappings":";;;;;;;;AAAA,MAAMA,QAAQC,QAAS,OAAT,CAAd;AACA,MAAMC,UAAUD,QAAS,UAAT,CAAhB;AACA,MAAME,IAAIF,QAAS,QAAT,CAAV;AACA,MAAM,EAAEG,mBAAF,KAA0BH,QAAS,uBAAT,CAAhC;AACA,MAAMI,KAAKJ,QAAS,IAAT,CAAX;AACA,MAAMK,OAAOL,QAAS,MAAT,CAAb;AACA,MAAMM,YAAYN,QAAS,qBAAT,CAAlB;;AAEA;AACA,MAAMO,UAAUF,MAAhB;;AAEA;AACA,MAAMG,WAAWR,QAAS,YAAT,CAAjB;;AAEA;AACA,IAAIS,eAAe,EAAnB;AACA,MAAMC,cAAc,IAAIC,OAAJ,EAApB;AACA,IAAI;AACFF,iBAAeG,KAAKC,KAAL,CACbT,GAAGU,YAAH,CAAiB,GAAEC,QAAQC,GAAR,EAAc,0BAAjC,CADa,CAAf;;AAIAd,IAAEe,IAAF,CAAOR,aAAaS,KAApB,EAA2B,CAACC,EAAD,EAAKC,IAAL,KAAc;AACvCC,gCAA4BD,IAA5B;AACD,GAFD;AAGD,CARD,CAQE,OAAOE,CAAP,EAAU;AACV;AACD;;AAED,IAAIC,KAAJ;AACA;AACA,IAAIR,QAAQS,GAAR,CAAYC,cAAZ,KAAgC,MAApC,EAA2C;AACzC,QAAMC,kBAAkB1B,QAAS,GAAEe,QAAQC,GAAR,EAAc,eAAzB,CAAxB;AACA,QAAMW,mBAAmBxB,oBAAoB;AAC3CyB,cAAU,IADiC;AAE3CC,UAAM,KAFqC;AAG3CC,UAAMJ,gBAAgBI;AAHqB,GAApB,CAAzB;AAKAP,UAAQxB,MAAMgC,WAAN,CACNhC,MAAMiC,eAAN,4BAA2BxB,QAA3B,EADM,EAENC,YAFM,EAGNkB,iBAAiB5B,MAAMkC,eAAN,EAAjB,CAHM,CAAR;AAKD,CAZD,MAYO;AACLV,UAAQxB,MAAMgC,WAAN,CACNhC,MAAMiC,eAAN,4BAA2BxB,QAA3B,EADM,EAENC,YAFM,CAAR;AAID;;AAED;AACA,MAAMyB,YAAYhC,EAAEiC,QAAF,CAAWC,SAAS;AACpC,QAAMC,cAAcnC,EAAEoC,IAAF,CAAOF,KAAP,EAAc,CAC/B,OAD+B,EAE/B,QAF+B,EAG/B,2BAH+B,CAAd,CAApB;AAKAhC,KAAGmC,SAAH,CACG,GAAExB,QAAQC,GAAR,EAAc,0BADnB,EAEEV,UAAU+B,WAAV,EAAuB,IAAvB,EAA6B,CAA7B,CAFF,EAGE,MAAM,CAAE,CAHV;AAKD,CAXiB,EAWf,IAXe,CAAlB;;AAaAd,MAAMiB,SAAN,CAAgB,MAAM;AACpB,QAAMC,aAAalB,MAAMmB,QAAN,GAAiBD,UAApC;AACAlC,UAAQoC,IAAR,CAAaF,WAAWG,IAAxB,EAA8BH,UAA9B;AACD,CAHD;;AAKAlC,QAAQsC,EAAR,CAAY,GAAZ,EAAgB,MAAM;AACpBX,YAAUX,MAAMmB,QAAN,EAAV;AACD,CAFD;;AAIAI,QAAQvC,OAAR,GAAkBA,OAAlB;AACAuC,QAAQvB,KAAR,GAAgBA,KAAhB;AACAuB,QAAQC,QAAR,GAAmB,MAAM;AACvB,MAAI7B,QAAQhB,EAAE8C,MAAF,CAASzB,MAAMmB,QAAN,GAAiBxB,KAA1B,CAAZ;AACA,SAAOA,QAAQA,KAAR,GAAgB,EAAvB;AACD,CAHD;AAIA,MAAM+B,UAAU9B,MAAMI,MAAMmB,QAAN,GAAiBxB,KAAjB,CAAuBC,EAAvB,CAAtB;AACA2B,QAAQG,OAAR,GAAkBA,OAAlB;AACAH,QAAQI,cAAR,GAAyB,CAAC/B,EAAD,EAAKgC,MAAL,KAAgB;AACvC,QAAM/B,OAAOG,MAAMmB,QAAN,GAAiBxB,KAAjB,CAAuBC,EAAvB,CAAb;AACA,MAAI,CAACC,IAAL,EAAW;AACT,WAAO,IAAP;AACD,GAFD,MAEO;AACL,WAAOA,KAAKgC,QAAL,CAAcC,aAAd,KAAgCF,MAAvC;AACD;AACF,CAPD;;AASAL,QAAQQ,eAAR,GAA0BlC,QAAQ;AAChC,MAAIA,KAAKgC,QAAL,CAAcG,OAAlB,EAA2B;AACzB,WAAOtD,QAAQuD,OAAR,CAAgBpC,KAAKgC,QAAL,CAAcG,OAA9B,CAAP;AACD,GAFD,MAEO;AACL,WAAO,IAAItD,OAAJ,CAAYuD,WAAW;AAC5B;AACA,YAAMC,SAASlC,MACZmB,QADY,GAEZgB,gBAFY,CAEKC,IAFL,CAEUC,QAAQA,KAAK9B,IAAL,KAAcV,KAAKgC,QAAL,CAAcS,KAF9C,CAAf;AAGA,YAAM,EAAEP,eAAF,KAAsBtD,QAAQyD,OAAOD,OAAf,CAA5B;AACA,UAAI,CAACF,eAAL,EAAsB;AACpB,cAAM,IAAIQ,KAAJ,CACH,sDAAqDL,OAAO3B,IAAK,EAD9D,CAAN;AAGD;;AAED,aAAOwB,gBAAgBlC,IAAhB,EAAsB2C,IAAtB,CAA2BR,WAAW;AAC3C;AACAC,gBAAQD,OAAR;AACD,OAHM,CAAP;AAID,KAhBM,CAAP;AAiBD;AACF,CAtBD;;AAwBAT,QAAQkB,4BAAR,GAAuC,CAAC7C,EAAD,EAAK8C,IAAL,KAAc;AACnD,QAAM,EAAEC,oBAAF,KAA2BlE,QAAS,+BAAT,CAAjC;AACA,QAAMoB,OAAO6B,QAAQ9B,EAAR,CAAb;AACA+C,uBAAqB,EAAED,IAAF,EAAQE,QAAQhD,EAAhB,EAArB;AACA,SAAOC,IAAP;AACD,CALD;;AAOA0B,QAAQsB,aAAR,GAAwBhD,QAAQV,YAAY2D,GAAZ,CAAgBjD,IAAhB,CAAhC;;AAEA,MAAMkD,wBAAwB,CAACC,IAAD,EAAOC,QAAP,KAAoB;AAChD,MAAItE,EAAEuE,aAAF,CAAgBF,IAAhB,KAAyBrE,EAAEwE,OAAF,CAAUH,IAAV,CAA7B,EAA8C;AAC5CrE,MAAEe,IAAF,CAAOsD,IAAP,EAAaI,KAAKL,sBAAsBK,CAAtB,EAAyBH,QAAzB,CAAlB;AACA9D,gBAAYkE,GAAZ,CAAgBL,IAAhB,EAAsBC,QAAtB;AACD;AACF,CALD;;AAOA,MAAMnD,8BAA8BD,QAAQ;AAC1ClB,IAAEe,IAAF,CAAOG,IAAP,EAAa,CAACyD,CAAD,EAAIC,CAAJ,KAAU;AACrB;AACA,QAAIA,MAAO,UAAX,EAAsB;AACpB;AACD;AACDR,0BAAsBO,CAAtB,EAAyBzD,KAAK2D,MAA9B;AACD,GAND;AAOD,CARD;AASAjC,QAAQzB,2BAAR,GAAsCA,2BAAtC;;AAEA;AACA;AACArB,QAAS,iBAAT","file":"index.js","sourcesContent":["const Redux = require(`redux`)\nconst Promise = require(`bluebird`)\nconst _ = require(`lodash`)\nconst { composeWithDevTools } = require(`remote-redux-devtools`)\nconst fs = require(`fs`)\nconst mitt = require(`mitt`)\nconst stringify = require(`json-stringify-safe`)\n\n// Create event emitter for actions\nconst emitter = mitt()\n\n// Reducers\nconst reducers = require(`./reducers`)\n\n// Read from cache the old node data.\nlet initialState = {}\nconst rootNodeMap = new WeakMap()\ntry {\n  initialState = JSON.parse(\n    fs.readFileSync(`${process.cwd()}/.cache/redux-state.json`)\n  )\n\n  _.each(initialState.nodes, (id, node) => {\n    trackSubObjectsToRootNodeId(node)\n  })\n} catch (e) {\n  // ignore errors.\n}\n\nlet store\n// Only setup the Redux devtools if explicitly enabled.\nif (process.env.REDUX_DEVTOOLS === `true`) {\n  const sitePackageJSON = require(`${process.cwd()}/package.json`)\n  const composeEnhancers = composeWithDevTools({\n    realtime: true,\n    port: 19999,\n    name: sitePackageJSON.name,\n  })\n  store = Redux.createStore(\n    Redux.combineReducers({ ...reducers }),\n    initialState,\n    composeEnhancers(Redux.applyMiddleware())\n  )\n} else {\n  store = Redux.createStore(\n    Redux.combineReducers({ ...reducers }),\n    initialState\n  )\n}\n\n// Persist state.\nconst saveState = _.debounce(state => {\n  const pickedState = _.pick(state, [\n    `nodes`,\n    `status`,\n    `componentDataDependencies`,\n  ])\n  fs.writeFile(\n    `${process.cwd()}/.cache/redux-state.json`,\n    stringify(pickedState, null, 2),\n    () => {}\n  )\n}, 1000)\n\nstore.subscribe(() => {\n  const lastAction = store.getState().lastAction\n  emitter.emit(lastAction.type, lastAction)\n})\n\nemitter.on(`*`, () => {\n  saveState(store.getState())\n})\n\nexports.emitter = emitter\nexports.store = store\nexports.getNodes = () => {\n  let nodes = _.values(store.getState().nodes)\n  return nodes ? nodes : []\n}\nconst getNode = id => store.getState().nodes[id]\nexports.getNode = getNode\nexports.hasNodeChanged = (id, digest) => {\n  const node = store.getState().nodes[id]\n  if (!node) {\n    return true\n  } else {\n    return node.internal.contentDigest !== digest\n  }\n}\n\nexports.loadNodeContent = node => {\n  if (node.internal.content) {\n    return Promise.resolve(node.internal.content)\n  } else {\n    return new Promise(resolve => {\n      // Load plugin's loader function\n      const plugin = store\n        .getState()\n        .flattenedPlugins.find(plug => plug.name === node.internal.owner)\n      const { loadNodeContent } = require(plugin.resolve)\n      if (!loadNodeContent) {\n        throw new Error(\n          `Could not find function loadNodeContent for plugin ${plugin.name}`\n        )\n      }\n\n      return loadNodeContent(node).then(content => {\n        // TODO update node's content field here.\n        resolve(content)\n      })\n    })\n  }\n}\n\nexports.getNodeAndSavePathDependency = (id, path) => {\n  const { createPageDependency } = require(`./actions/add-page-dependency`)\n  const node = getNode(id)\n  createPageDependency({ path, nodeId: id })\n  return node\n}\n\nexports.getRootNodeId = node => rootNodeMap.get(node)\n\nconst addParentToSubObjects = (data, parentId) => {\n  if (_.isPlainObject(data) || _.isArray(data)) {\n    _.each(data, o => addParentToSubObjects(o, parentId))\n    rootNodeMap.set(data, parentId)\n  }\n}\n\nconst trackSubObjectsToRootNodeId = node => {\n  _.each(node, (v, k) => {\n    // Ignore the node internal object.\n    if (k === `internal`) {\n      return\n    }\n    addParentToSubObjects(v, node.parent)\n  })\n}\nexports.trackSubObjectsToRootNodeId = trackSubObjectsToRootNodeId\n\n// Start plugin runner which listens to the store\n// and invokes Gatsby API based on actions.\nrequire(`./plugin-runner`)\n"]}