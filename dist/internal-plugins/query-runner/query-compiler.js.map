{"version":3,"sources":["../../../src/internal-plugins/query-runner/query-compiler.js"],"names":["normalize","require","_","printTransforms","ArgumentsOfCorrectTypeRule","DefaultValuesOfCorrectTypeRule","FragmentsOnCompositeTypesRule","KnownTypeNamesRule","LoneAnonymousOperationRule","PossibleFragmentSpreadsRule","ScalarLeafsRule","VariablesAreInputTypesRule","VariablesInAllowedPositionRule","validationRules","Runner","constructor","baseDir","fragmentsDir","schema","reportError","message","log","format","red","compileAll","nodes","parseEverything","write","files","sync","concat","filter","d","match","map","Object","keys","getState","components","c","uniq","parser","parseFiles","compiledNodes","Map","namePathMap","nameDefMap","documents","filePath","doc","entries","errors","length","push","definitions","forEach","def","name","value","set","compilerContext","addAll","convertASTDocuments","transform","bind","error","printContext","reduce","ctx","node","kind","get","has","otherNode","text","getRoot","print","join","path","program","runner","directory","queries","compile"],"mappings":"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","file":"query-compiler.js","sourcesContent":["// @flow\nimport path from \"path\"\nconst normalize = require(`normalize-path`)\nimport glob from \"glob\"\n\nimport { validate } from \"graphql\"\nimport { IRTransforms } from \"relay-compiler\"\nimport RelayParser from \"relay-compiler/lib/RelayParser\"\nimport ASTConvert from \"relay-compiler/lib/ASTConvert\"\nimport GraphQLCompilerContext from \"relay-compiler/lib/GraphQLCompilerContext\"\nimport filterContextForNode from \"relay-compiler/lib/filterContextForNode\"\nconst _ = require(`lodash`)\n\nimport { store } from \"../../redux\"\nimport FileParser from \"./file-parser\"\nimport GraphQLIRPrinter from \"relay-compiler/lib/GraphQLIRPrinter\"\nimport {\n  graphqlError,\n  graphqlValidationError,\n  multipleRootQueriesError,\n} from \"./graphql-errors\"\nimport report from \"gatsby-cli/lib/reporter\"\n\nimport type { DocumentNode, GraphQLSchema } from \"graphql\"\n\nconst { printTransforms } = IRTransforms\n\nconst {\n  ArgumentsOfCorrectTypeRule,\n  DefaultValuesOfCorrectTypeRule,\n  FragmentsOnCompositeTypesRule,\n  KnownTypeNamesRule,\n  LoneAnonymousOperationRule,\n  PossibleFragmentSpreadsRule,\n  ScalarLeafsRule,\n  VariablesAreInputTypesRule,\n  VariablesInAllowedPositionRule,\n} = require(`graphql`)\n\ntype RootQuery = {\n  name: string,\n  path: string,\n  text: string,\n}\n\ntype Queries = Map<string, RootQuery>\n\nconst validationRules = [\n  ArgumentsOfCorrectTypeRule,\n  DefaultValuesOfCorrectTypeRule,\n  FragmentsOnCompositeTypesRule,\n  KnownTypeNamesRule,\n  LoneAnonymousOperationRule,\n  PossibleFragmentSpreadsRule,\n  ScalarLeafsRule,\n  VariablesAreInputTypesRule,\n  VariablesInAllowedPositionRule,\n]\n\nclass Runner {\n  baseDir: string\n  schema: GraphQLSchema\n  fragmentsDir: string\n\n  constructor(baseDir: string, fragmentsDir: string, schema: GraphQLSchema) {\n    this.baseDir = baseDir\n    this.fragmentsDir = fragmentsDir\n    this.schema = schema\n  }\n\n  reportError(message) {\n    report.log(`${report.format.red(`GraphQL Error`)} ${message}`)\n  }\n\n  async compileAll() {\n    let nodes = await this.parseEverything()\n    return await this.write(nodes)\n  }\n\n  async parseEverything() {\n    // FIXME: this should all use gatsby's configuration to determine parsable\n    // files (and how to parse them)\n    let files = glob.sync(`${this.fragmentsDir}/**/*.+(t|j)s?(x)`)\n    files = files.concat(glob.sync(`${this.baseDir}/**/*.+(t|j)s?(x)`))\n    files = files.filter(d => !d.match(/\\.d\\.ts$/))\n    files = files.map(normalize)\n\n    // Ensure all page components added as they're not necessarily in the\n    // pages directory e.g. a plugin could add a page component.  Plugins\n    // *should* copy their components (if they add a query) to .cache so that\n    // our babel plugin to remove the query on building is active (we don't\n    // run babel on code in node_modules). Otherwise the component will throw\n    // an error in the browser of \"graphql is not defined\".\n    files = files.concat(\n      Object.keys(store.getState().components).map(c => normalize(c))\n    )\n    files = _.uniq(files)\n\n    let parser = new FileParser()\n\n    return await parser.parseFiles(files)\n  }\n\n  async write(nodes: Map<string, DocumentNode>): Promise<Queries> {\n    const compiledNodes: Queries = new Map()\n    const namePathMap = new Map()\n    const nameDefMap = new Map()\n    const documents = []\n\n    for (let [filePath, doc] of nodes.entries()) {\n      let errors = validate(this.schema, doc, validationRules)\n\n      if (errors && errors.length) {\n        this.reportError(graphqlValidationError(errors, filePath))\n        return compiledNodes\n      }\n\n      documents.push(doc)\n      doc.definitions.forEach((def: any) => {\n        const name: string = def.name.value\n        namePathMap.set(name, filePath)\n        nameDefMap.set(name, def)\n      })\n    }\n\n    let compilerContext = new GraphQLCompilerContext(this.schema)\n    try {\n      compilerContext = compilerContext.addAll(\n        ASTConvert.convertASTDocuments(\n          this.schema,\n          documents,\n          validationRules,\n          RelayParser.transform.bind(RelayParser)\n        )\n      )\n    } catch (error) {\n      this.reportError(graphqlError(namePathMap, nameDefMap, error))\n      return compiledNodes\n    }\n\n    const printContext = printTransforms.reduce(\n      (ctx, transform) => transform(ctx, this.schema),\n      compilerContext\n    )\n\n    compilerContext.documents().forEach((node: { name: string }) => {\n      if (node.kind !== `Root`) return\n\n      const { name } = node\n      let filePath = namePathMap.get(name) || ``\n\n      if (compiledNodes.has(filePath)) {\n        let otherNode = compiledNodes.get(filePath)\n        this.reportError(\n          multipleRootQueriesError(\n            filePath,\n            nameDefMap.get(name),\n            otherNode && nameDefMap.get(otherNode.name)\n          )\n        )\n        return\n      }\n\n      let text = filterContextForNode(printContext.getRoot(name), printContext)\n        .documents()\n        .map(GraphQLIRPrinter.print)\n        .join(`\\n`)\n\n      compiledNodes.set(filePath, {\n        name,\n        text,\n        path: path.join(this.baseDir, filePath),\n      })\n    })\n\n    return compiledNodes\n  }\n}\nexport { Runner }\n\nexport default async function compile(): Promise<Map<string, RootQuery>> {\n  const { program, schema } = store.getState()\n\n  const runner = new Runner(\n    `${program.directory}/src`,\n    `${program.directory}/.cache/fragments`,\n    schema\n  )\n\n  const queries = await runner.compileAll()\n\n  return queries\n}\n"]}